<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Node Hosting Dashboard</title>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #1a1a2e;
      margin: 0;
      padding: 0;
      color: #eaeaea;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background-color: #0f3460;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }

    .navbar h2 {
      margin: 0;
      font-size: 1.5em;
      font-weight: 600;
    }

    .wallet-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .wallet-info button {
      background-color: #e94560;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    .wallet-info button:hover {
      background-color: #ff5c7a;
    }

    .dashboard {
      max-width: 1400px;
      margin: 30px auto;
      padding: 20px;
      background-color: #16213e;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .dashboard-header h1 {
      font-size: 1.8em;
      font-weight: 700;
      margin: 0;
    }

    .action-button {
      background-color: #e94560;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 0.9em;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .action-button:hover {
      background-color: #ff5c7a;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding-bottom: 30px;
    }

    .card {
      background-color: #1a1a2e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      margin: 0 0 15px;
      font-size: 1.2em;
      font-weight: 600;
    }

    .card p {
      margin: 5px 0;
      font-size: 0.9em;
      color: #c1c1c1;
    }

    .card-actions {
      margin-top: 15px;
    }

    .card-actions button {
      background-color: #0f3460;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s ease;
    }

    .card-actions button:hover {
      background-color: #3282b8;
    }

    .footer {
      margin-top: 50px;
      text-align: center;
      font-size: 0.8em;
      color: #7a7a7a;
    }

    .footer a {
      color: #e94560;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>Node Hosting Dashboard</h2>
    <div class="wallet-info">
      <span id="walletDisplay">Wallet: Not Connected</span>
      <span id="balanceDisplay">Balance: 0 ALEPH</span>
      <button id="connectWalletButton">Connect Wallet</button>
    </div>
  </div>

  <div id="dashboard" class="dashboard">
    <div class="dashboard-header">
      <h1>Your Nodes</h1>
      <button class="action-button" onclick="createNode()">+ Create New Node</button>
    </div>
    <div class="grid-container" id="nodeGrid"></div>
    <div class="grid-container">
      <div class="card">
        <h3>Resource Usage</h3>
        <p>Total CPU: <strong>2 vCPUs</strong></p>
        <p>Total Memory: <strong>4 GB</strong></p>
      </div>
      <div class="card">
        <h3>Billing Information</h3>
        <p>Current Month: <strong>50 ALEPH</strong></p>
        <p>Total Usage: <strong>200 ALEPH</strong></p>
      </div>
    </div>
  </div>

  <div class="footer">
    If you have issues, please <a href="#">contact support</a>.
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/@aleph-sdk/client/dist/index.umd.min.js"
    onload="console.log('Aleph SDK loaded');"
  ></script>

  <script>
    const walletDisplay = document.getElementById('walletDisplay');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const connectWalletButton = document.getElementById('connectWalletButton');
    const nodeGrid = document.getElementById('nodeGrid');
  
    let alephClient;
    let alephAccount;
    const alephChannel = "ALEPH-CLOUDSOLUTIONS";
    const alephNodeUrl = "https://46.255.204.193";
  
    async function connectWallet() {
      if (!window.ethereum) {
        alert('MetaMask is required to use this application.');
        return;
      }
  
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      const signer = provider.getSigner();
      const address = await signer.getAddress();
  
      try {
        // Dynamically create Aleph account
        /*
        if (window.aleph?.ethereum?.Web3Account) {
          alephAccount = new window.aleph.ethereum.Web3Account({
            address,
            sign: async (msg) => await signer.signMessage(msg),
          });
        } else {
          throw new Error("Aleph SDK or Web3Account not properly loaded.");
        }
  
        // Initialize Aleph Client
        alephClient = new window.aleph.AuthenticatedAlephHttpClient({
          account: alephAccount,
          node_url: alephNodeUrl,
        });
        */
  
        console.log('Aleph client initialized:', alephClient);
  
        walletDisplay.textContent = `Wallet: ${address.slice(0, 6)}...${address.slice(-4)}`;
        balanceDisplay.textContent = `Balance: Fetching...`;
  
        const balance = await fetchTokenBalance(provider, address);
        balanceDisplay.textContent = `Balance: ${balance} ALEPH`;
  
        connectWalletButton.textContent = 'Disconnect';
        connectWalletButton.onclick = disconnectWallet;
  
        await listInstances();
      } catch (error) {
        console.error("Error connecting wallet:", error);
        alert("Error initializing Aleph client. Check the console for details.");
      }
    }
  
    async function fetchTokenBalance(provider, address) {
      const tokenAddress = '0x27702a26126e0B3702af63Ee09aC4d1A084EF628';
      const tokenABI = [
        'function balanceOf(address owner) view returns (uint256)',
        'function decimals() view returns (uint8)',
      ];
      const contract = new ethers.Contract(tokenAddress, tokenABI, provider);
      const balance = await contract.balanceOf(address);
      const decimals = await contract.decimals();
      return ethers.utils.formatUnits(balance, decimals);
    }
  
    async function listInstances() {
      if (!alephClient) {
        console.error('Aleph client not initialized.');
        return;
      }
  
      try {
        const response = await alephClient.getMessages({
          types: ['INSTANCE'],
          addresses: [alephAccount.address],
        });
  
        nodeGrid.innerHTML = ''; // Clear existing nodes
        for (const message of response.messages) {
          const instanceId = message.item_hash;
          const ipv6 = await fetchInstanceIp(instanceId);
          renderNode({
            id: instanceId,
            ipv6: ipv6 || 'Unavailable',
            status: message.confirmed ? 'Running' : 'Pending',
            uptime: '0h 0m',
          });
        }
      } catch (error) {
        console.error('Error fetching instances:', error);
      }
    }
  
    async function fetchInstanceIp(instanceId) {
      try {
        const response = await fetch(`https://scheduler.api.aleph.cloud/api/v0/allocation/${instanceId}`);
        const data = await response.json();
        return data.vm_ipv6 || null;
      } catch (error) {
        console.error(`Failed to fetch IP for instance ${instanceId}:`, error);
        return null;
      }
    }
  
    function renderNode(node) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${node.id}</h3>
        <p><strong>IPv6:</strong> ${node.ipv6}</p>
        <p><strong>Status:</strong> ${node.status}</p>
        <p><strong>Uptime:</strong> ${node.uptime}</p>
        <div class="card-actions">
          <button onclick="deleteNode('${node.id}')">Delete</button>
        </div>
      `;
      nodeGrid.appendChild(card);
    }
  
    function disconnectWallet() {
      walletDisplay.textContent = 'Wallet: Not Connected';
      balanceDisplay.textContent = 'Balance: 0 ALEPH';
      connectWalletButton.textContent = 'Connect Wallet';
      connectWalletButton.onclick = connectWallet;
      nodeGrid.innerHTML = '';
    }
  
    connectWalletButton.addEventListener('click', connectWallet);
  </script>
  
</body>
</html>
